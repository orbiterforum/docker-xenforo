#!/bin/bash

set -e

DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
TESTS_DIR="$DIR/tests"

VERSION="7.1.4"
EXT_INSTALL="exif gd mcrypt memcached mysqli opcache pcntl zip"
PECL_INSTALL="imagick redis"

for d in */ ; do
	cd "$DIR/$d"
	if [ -f Dockerfile ]; then
		export TAG="xfrocks/xenforo:${d%?}"
		export TAG_WITH_VERSION="$TAG-$VERSION"

		docker build \
			--build-arg DOCKER_XENFORO_PHP_EXT_INSTALL="$EXT_INSTALL" \
			--build-arg DOCKER_XENFORO_PHP_PECL_INSTALL="$PECL_INSTALL" \
			-t "$TAG" \
			-t "$TAG_WITH_VERSION" \
			.

		eval "$TESTS_DIR/run.sh"

		docker push "$TAG"
		docker push "$TAG_WITH_VERSION"

		export TAG_DEBUG="$TAG_WITH_VERSION-debug"
		export DIR_DEBUG="xfrocks-xenforo-$VERSION"
		cd /tmp
		if [ -d "$DIR_DEBUG" ]; then
			rm -rf "$DIR_DEBUG"
		fi
		mkdir "$DIR_DEBUG"
		cd "$DIR_DEBUG"
		echo "FROM $TAG_WITH_VERSION" > Dockerfile
		echo '' >> Dockerfile
		echo 'RUN docker-php-ext-enable xdebug \' >> Dockerfile
		echo '	&& echo "xdebug.remote_enable=on" >> /usr/local/etc/php/conf.d/xdebug.ini \' >> Dockerfile
		echo '	&& echo "xdebug.remote_connect_back=on" >> /usr/local/etc/php/conf.d/xdebug.ini' >> Dockerfile
		docker build -t "$TAG_DEBUG" .
		docker push "$TAG_DEBUG"
	fi
done

